<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Giftup Real Multiplayer V4</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --blue: #007aff; --green: #34c759; --red: #ff3b30; }
        
        body { 
            background: #000; 
            color: #fff; 
            font-family: -apple-system, sans-serif; 
            margin: 0; padding: 0; overflow: hidden; height: 100vh; 
        }

        .header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1a1a1a; height: 50px; box-sizing: border-box; }
        .balance { background: var(--green); color: #000; padding: 4px 12px; border-radius: 20px; font-weight: 800; font-size: 14px; }
        #online-tag { font-size: 11px; color: var(--blue); font-weight: bold; }

        .screen { display: none; height: calc(100vh - 50px); flex-direction: column; }
        .active { display: flex; }

        .history { padding: 8px 10px; display: flex; gap: 8px; overflow-x: auto; border-bottom: 1px solid #1a1a1a; scrollbar-width: none; background: #000; }
        .hs-item { background: #111; padding: 5px 12px; border-radius: 6px; font-size: 12px; border: 1px solid #222; min-width: 45px; text-align: center; color: #888; }

        /* –Ü–ì–†–û–í–ê –ó–û–ù–ê –ó –§–û–ù–û–ú */
        .viewport { 
            flex-grow: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            overflow: hidden; /* –û–±—Ä—ñ–∑–∞—î–º–æ —Ñ–æ–Ω –ø–æ –∫—Ä–∞—è—Ö */
            background: #000;
        }

        #bg-video {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1; /* –ü—ñ–¥ —Ä–∞–∫–µ—Ç–∫–æ—é */
        }

        #rocket-vid { 
            width: 280px; 
            mix-blend-mode: screen; 
            transform: scale(0); 
            transition: 0.3s ease; 
            z-index: 2; /* –ù–∞–¥ —Ñ–æ–Ω–æ–º */
        }

        .controls { padding: 15px; border-top: 1px solid #1a1a1a; background: #000; }
        input { width: 100%; background: #111; border: 1px solid #222; padding: 12px; color: #fff; border-radius: 10px; text-align: center; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; outline: none; }
        .btn-main { width: 100%; padding: 18px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; color: #fff; cursor: pointer; text-transform: uppercase; }

        .bets-scroll { 
            height: 140px; 
            overflow-y: scroll; 
            -webkit-overflow-scrolling: touch; 
            padding: 10px 15px; 
            border-top: 1px solid #1a1a1a; 
            background: #050505; 
        }
        .bet-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; padding-bottom: 5px; border-bottom: 1px solid #111; }
        .u-box { display: flex; align-items: center; gap: 10px; }
        .u-avatar { width: 28px; height: 28px; border-radius: 50%; background: #222; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="font-weight: 900; letter-spacing: 1px;">GIFTUP</div>
            <div id="online-tag">Online: 0</div>
        </div>
        <div class="balance"><span id="user-bal">500.00</span> ‚Ç¥</div>
    </div>

    <div id="lobby-screen" class="screen active">
        <div style="padding: 20px;">
            <div style="background:#141416; padding:15px; border-radius:12px; border:1px solid #222; display:flex; align-items:center; gap:12px;">
                <img id="pfp" src="" class="u-avatar" style="width:45px; height:45px;">
                <div>
                    <div id="username" style="font-weight: bold;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                    <div style="font-size: 10px; color: #555;">ID: <span id="uid">0</span></div>
                </div>
            </div>
            <div onclick="startGame()" style="background:#141416; margin-top:20px; padding:40px 20px; border-radius:16px; text-align:center; border:1px solid #222; cursor:pointer;">
                <div style="font-size:50px; margin-bottom:10px;">üöÄ</div>
                <h3 style="margin:0;">–ì–†–ê–¢–ò –ó –†–ï–ê–õ–¨–ù–ò–ú–ò –ì–†–ê–í–¶–Ø–ú–ò</h3>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="history" id="history-bar">
            <div id="live-multiplier" class="hs-item" style="color:var(--blue); border-color:var(--blue); font-weight:bold;">0.0s</div>
        </div>
        <div class="viewport">
            <video autoplay muted loop playsinline id="bg-video">
                <source src="https://files.catbox.moe/d91l6n.mp4" type="video/mp4">
            </video>
            
            <video id="rocket-vid" playsinline muted loop>
                <source src="https://files.catbox.moe/gkhz5v.mp4" type="video/mp4">
            </video>
        </div>
        <div class="controls">
            <input type="number" id="bet-input" value="100" min="1">
            <button id="main-action" class="btn-main" style="background:var(--blue);" onclick="handleBet()">–°–¢–ê–í–ö–ê</button>
        </div>
        <div class="bets-scroll" id="bets-container"></div>
        <button onclick="exitGame()" style="background:none; border:none; color:#444; padding:10px; font-size:12px; cursor:pointer;">‚Üê –í–ò–ô–¢–ò</button>
    </div>

    <script>
        const socket = io();
        const tg = window.Telegram.WebApp;
        tg.expand();

        const userData = tg.initDataUnsafe?.user || { first_name: "–ì—Ä–∞–≤–µ—Ü—å", id: "0" };
        const uName = userData.username ? "@" + userData.username : userData.first_name;
        const uPhoto = userData.photo_url || `https://ui-avatars.com/api/?name=${uName}&background=333&color=fff`;

        document.getElementById('username').innerText = uName;
        document.getElementById('uid').innerText = userData.id;
        document.getElementById('pfp').src = uPhoto;

        let myBalance = parseFloat(localStorage.getItem('g_bal')) || 500.00;
        let activeBet = 0;
        let isCashedOut = false;
        let currentRoundId = -1;

        function syncBal() {
            document.getElementById('user-bal').innerText = myBalance.toFixed(2);
            localStorage.setItem('g_bal', myBalance);
        }

        socket.on('update_online', (count) => {
            document.getElementById('online-tag').innerText = "Online: " + count;
        });

        socket.on('update_bets', (allBets) => {
            const container = document.getElementById('bets-container');
            container.innerHTML = "";
            allBets.forEach(bet => {
                container.innerHTML += `
                    <div class="bet-row">
                        <div class="u-box"><img src="${bet.photo}" class="u-avatar"><span>${bet.name}</span></div>
                        <span style="font-weight:bold; color:${bet.status === 'win' ? 'var(--green)' : 'var(--blue)'}">
                            ${bet.status === 'win' ? '+' + bet.winAmount + ' ‚Ç¥' : bet.amount + ' ‚Ç¥'}
                        </span>
                    </div>`;
            });
        });

        function startGame() {
            document.getElementById('lobby-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
        }

        function exitGame() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('lobby-screen').classList.add('active');
        }

        function handleBet() {
            const now = Date.now();
            const ms = now % 20000;
            const btn = document.getElementById('main-action');
            const amount = parseFloat(document.getElementById('bet-input').value);

            if (ms < 6000 && activeBet === 0) {
                if (amount > myBalance || amount <= 0) return;
                myBalance -= amount; activeBet = amount; isCashedOut = false; syncBal();
                socket.emit('place_bet', { name: uName, amount: amount, photo: uPhoto, status: 'active' });
                btn.innerText = "–ü–†–ò–ô–ù–Ø–¢–û"; btn.style.background = "#1a1a1a";
            } 
            else if (ms >= 6000 && activeBet > 0 && !isCashedOut) {
                const currentX = 1 + ((ms - 6000) / 1000) * 0.15;
                const crashPoint = 1.1 + ((Math.floor(now / 20000) * 157) % 40) / 10;
                
                if (currentX < crashPoint) {
                    let profit = activeBet * currentX;
                    myBalance += profit; isCashedOut = true; syncBal();
                    btn.innerText = `+${profit.toFixed(0)} ‚Ç¥`;
                    btn.style.background = "var(--green)"; btn.style.color = "#000";
                    socket.emit('player_win', { name: uName, winAmount: profit.toFixed(0) });
                    activeBet = 0;
                }
            }
        }

        function engine() {
            const now = Date.now();
            const ms = now % 20000;
            const rid = Math.floor(now / 20000);
            const btn = document.getElementById('main-action');
            const vid = document.getElementById('rocket-vid');
            const multiplierDisp = document.getElementById('live-multiplier');

            // –ú–ò–¢–¢–Ñ–í–ï –û–ß–ò–©–ï–ù–ù–Ø –ü–†–ò –ó–ú–Ü–ù–Ü –†–ê–£–ù–î–£
            if (rid !== currentRoundId) {
                currentRoundId = rid;
                if (!isCashedOut) activeBet = 0;
                socket.emit('reset_all_bets'); // –ö–æ–º–∞–Ω–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –æ—á–∏—Å—Ç–∏—Ç–∏ —Å—Ç–∞–≤–∫–∏
            }

            const crashAt = 1.1 + ((rid * 157) % 40) / 10;
            const timeToCrash = (crashAt - 1) / 0.15 * 1000;

            if (ms < 6000) {
                multiplierDisp.innerText = ((6000 - ms) / 1000).toFixed(1) + "s";
                multiplierDisp.style.color = "var(--blue)";
                vid.style.transform = "scale(0)"; vid.pause();
                if (activeBet === 0) { btn.innerText = "–°–¢–ê–í–ö–ê"; btn.style.background = "var(--blue)"; btn.style.color="#fff"; }
            } else if (ms < 6000 + timeToCrash) {
                const x = (1 + ((ms - 6000) / 1000) * 0.15).toFixed(2);
                multiplierDisp.innerText = x + "x"; multiplierDisp.style.color = "var(--green)";
                vid.style.transform = "scale(1)"; vid.play();
                if (activeBet > 0 && !isCashedOut) {
                    btn.innerText = "–ó–ê–ë–†–ê–¢–ò " + (activeBet * x).toFixed(0);
                    btn.style.background = "var(--green)"; btn.style.color = "#000";
                }
            } else {
                multiplierDisp.innerText = crashAt.toFixed(2) + "x"; multiplierDisp.style.color = "var(--red)";
                vid.style.transform = "scale(0)";
                if (activeBet > 0 && !isCashedOut) {
                    btn.innerText = "BOOM!"; btn.style.background = "var(--red)"; btn.style.color="#fff";
                    activeBet = 0;
                }
            }
        }
        setInterval(engine, 50); syncBal();
    </script>
</body>
</html>
