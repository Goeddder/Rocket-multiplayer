<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rocket Ultra Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --blue: #007aff; --green: #34c759; --red: #ff3b30; --gray: #1c1c1e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; height: 100vh; }

        /* Фонове відео */
        .bg-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; z-index: 0; }

        /* Шапка гри з Онлайном */
        .game-header { 
            position: absolute; top: 10px; left: 0; width: 100%; padding: 0 15px;
            display: flex; justify-content: space-between; align-items: flex-start; z-index: 100; 
        }
        .online-counter { 
            background: rgba(0, 255, 0, 0.1); border: 1px solid var(--green); 
            padding: 4px 10px; border-radius: 20px; color: var(--green); font-size: 11px; font-weight: 800;
            display: flex; align-items: center; gap: 5px;
        }
        .online-dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; box-shadow: 0 0 5px var(--green); }

        .balance-badge { background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 12px; border: 1px solid #333; font-weight: 900; color: var(--green); }

        /* Історія іксів */
        .history-bar { 
            display: flex; gap: 8px; padding: 55px 15px 10px; 
            overflow-x: auto; position: relative; z-index: 10;
        }
        .hs-item { background: #1c1c1e; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; color: #aaa; border: 1px solid #333; }

        /* Головний екран */
        .viewport { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; height: 40vh; }
        #rocket-vid { width: 200px; z-index: 2; transition: 0.3s; }
        #live-x { font-size: 60px; font-weight: 900; margin-top: -20px; z-index: 3; text-shadow: 0 0 20px rgba(0,122,255,0.5); }

        /* Список ставок (Реальні гравці) */
        .bets-container { background: #0a0a0a; border-radius: 20px 20px 0 0; flex-grow: 1; display: flex; flex-direction: column; border-top: 1px solid #222; z-index: 10; overflow: hidden; }
        .bets-header { padding: 12px 20px; font-size: 12px; color: #555; display: flex; justify-content: space-between; border-bottom: 1px solid #111; }
        .bets-list { flex-grow: 1; overflow-y: auto; padding: 10px 15px; }

        /* СТИЛЬ СТАВКИ-КНОПКИ */
        .bet-row { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 10px 15px; background: var(--gray); border-radius: 12px; 
            margin-bottom: 8px; border: 1px solid #2c2c2e; 
        }
        .bet-row.my-bet { border-color: var(--blue); background: #242426; }
        .bet-info { display: flex; align-items: center; gap: 10px; }
        .bet-info img { width: 28px; height: 28px; border-radius: 50%; }
        .bet-res { text-align: right; }
        .win-txt { color: var(--green); font-weight: 800; }

        /* Керування */
        .controls { padding: 20px; background: #0a0a0a; border-top: 1px solid #222; z-index: 100; }
        #main-btn { 
            width: 100%; padding: 18px; border-radius: 15px; border: none; 
            font-size: 18px; font-weight: 900; color: #fff; 
            background: linear-gradient(90deg, #007aff, #00c6ff);
        }
        #main-btn.cashout { background: var(--green); }
    </style>
</head>
<body>

    <video autoplay muted loop playsinline class="bg-video"><source src="https://files.catbox.moe/d91l6n.mp4"></video>

    <div class="game-header">
        <div class="balance-badge"><span id="u-bal">500</span> ₴</div>
        <div class="online-counter">
            <div class="online-dot"></div>
            ONLINE: <span id="online-val">1</span>
        </div>
    </div>

    <div class="history-bar" id="history"></div>

    <div class="viewport">
        <video id="rocket-vid" playsinline muted loop><source src="https://files.catbox.moe/gkhz5v.mp4"></video>
        <div id="live-x">1.00x</div>
    </div>

    <div class="bets-container">
        <div class="bets-header">
            <span>ГРАВЕЦЬ</span>
            <span>СТАВКА / ВИГРАШ</span>
        </div>
        <div class="bets-list" id="bets-list">
            </div>
    </div>

    <div class="controls">
        <input type="number" id="bet-amt" value="100" style="width:100%; background:#1c1c1e; border:1px solid #333; color:#fff; padding:12px; border-radius:10px; text-align:center; margin-bottom:12px; font-size:16px;">
        <button id="main-btn" onclick="handleAction()">СТАВКА</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const user = tg.initDataUnsafe?.user || { first_name: "Гість", id: 0 };
        const uName = user.first_name;
        const uAvatar = user.photo_url || `https://ui-avatars.com/api/?name=${uName}&background=007aff&color=fff`;

        let balance = parseFloat(localStorage.getItem('rocket_bal')) || 500.00;
        let activeBet = 0, isCashed = false, gamePhase = "wait", phaseStart = Date.now();
        let currentX = 1.0, crashAt = 2.0;

        function updateBal() {
            document.getElementById('u-bal').innerText = balance.toFixed(2);
            localStorage.setItem('rocket_bal', balance);
        }

        function addBetRow(name, avatar, amount, x = "", win = "", isWin = false) {
            const list = document.getElementById('bets-list');
            let row = document.getElementById('row-' + name);
            if (!row) {
                row = document.createElement('div');
                row.id = 'row-' + name;
                row.className = 'bet-row' + (name === uName ? ' my-bet' : '');
                list.prepend(row);
            }
            row.innerHTML = `
                <div class="bet-info">
                    <img src="${avatar}">
                    <span style="font-weight:700; font-size:13px;">${name}</span>
                </div>
                <div class="bet-res">
                    <div style="font-size:10px; color:var(--blue); font-weight:800;">${x ? x+'x' : ''}</div>
                    <div class="${isWin ? 'win-txt' : ''}" style="font-size:14px; font-weight:800;">${isWin ? '+'+win : amount} ₴</div>
                </div>
            `;
        }

        function handleAction() {
            const btn = document.getElementById('main-btn');
            const amt = parseFloat(document.getElementById('bet-amt').value);

            if (gamePhase === "wait" && activeBet === 0) {
                if (amt > balance || amt <= 0) return;
                balance -= amt; activeBet = amt; isCashed = false;
                updateBal();
                addBetRow(uName, uAvatar, activeBet);
                btn.innerText = "ОЧІКУВАННЯ...";
                btn.style.opacity = "0.6";
            } 
            else if (gamePhase === "fly" && activeBet > 0 && !isCashed) {
                let win = (activeBet * currentX).toFixed(0);
                balance += parseFloat(win); isCashed = true;
                updateBal();
                addBetRow(uName, uAvatar, activeBet, currentX.toFixed(2), win, true);
                btn.innerText = `+${win} ₴`;
                btn.classList.add('cashout');
                activeBet = 0;
            }
        }

        function gameLoop() {
            const now = Date.now();
            const elapsed = now - phaseStart;
            const xEl = document.getElementById('live-x');
            const btn = document.getElementById('main-btn');
            const vid = document.getElementById('rocket-vid');

            if (gamePhase === "wait") {
                let timer = ((6000 - elapsed) / 1000).toFixed(1);
                xEl.innerText = timer + "s";
                xEl.style.color = "#fff";
                vid.style.transform = "scale(0.8)";
                // Імітація росту онлайну
                document.getElementById('online-val').innerText = Math.floor(Math.random() * 10 + 40);
                
                if (timer <= 0) {
                    gamePhase = "fly"; phaseStart = now;
                    crashAt = (Math.random() < 0.1) ? 1.05 : (Math.random() * 4 + 1.1);
                    vid.style.transform = "scale(1.2)"; vid.play();
                    if (activeBet > 0) { btn.innerText = "ЗАБРАТИ"; btn.style.opacity = "1"; }
                }
            } 
            else if (gamePhase === "fly") {
                currentX = 1 + (elapsed / 1000) * 0.2;
                xEl.innerText = currentX.toFixed(2) + "x";
                xEl.style.color = "var(--blue)";

                // Оновлюємо свою ставку в реальному часі
                if (activeBet > 0 && !isCashed) {
                    addBetRow(uName, uAvatar, activeBet, currentX.toFixed(2), (activeBet * currentX).toFixed(0));
                    btn.innerText = "ЗАБРАТИ " + (activeBet * currentX).toFixed(0);
                }

                if (currentX >= crashAt) {
                    gamePhase = "boom"; phaseStart = now;
                    xEl.innerText = "BOOM!";
                    xEl.style.color = "var(--red)";
                    vid.style.transform = "scale(0)";
                    
                    const h = document.getElementById('history');
                    h.innerHTML = `<div class="hs-item" style="color:var(--red)">${crashAt.toFixed(2)}x</div>` + h.innerHTML;
                }
            } 
            else if (gamePhase === "boom") {
                if (elapsed > 2000) {
                    gamePhase = "wait"; phaseStart = now;
                    document.getElementById('bets-list').innerHTML = '';
                    btn.innerText = "СТАВКА"; btn.classList.remove('cashout'); btn.style.opacity = "1";
                    activeBet = 0;
                }
            }
            requestAnimationFrame(gameLoop);
        }

        updateBal();
        gameLoop();
    </script>
</body>
</html>
